<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Đề xuất tài chính - CatCredit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #fec629;
            --primary-hover: #e5b225;
            --text-dark: #1f2937;
            --text-gray: #6b7280;
            --bg-light: #f3f4f6;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-light); color: var(--text-dark); -webkit-font-smoothing: antialiased; }

        /* HEADER */
        .site-header { background: var(--white); padding: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .header-container { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; }
        .logo img { height: 35px; width: auto; }
        .nav-link { text-decoration: none; color: var(--text-dark); font-weight: 500; font-size: 14px; display: flex; align-items: center; gap: 5px; }

        /* MAIN CONTENT */
        .main-container { max-width: 1200px; margin: 30px auto; padding: 0 15px; }
        
        .section-title { 
            font-size: 20px; font-weight: 700; margin-bottom: 20px; 
            display: flex; align-items: center; gap: 10px;
        }
        .section-title::before { content: ''; display: block; width: 4px; height: 24px; background: var(--primary); border-radius: 2px; }

        /* GRID SYSTEM */
        .offers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); /* Card nhỏ gọn hơn */
            gap: 20px;
        }

        /* CARD DESIGN - MODERN */
        .offer-card {
            background: var(--white); border-radius: var(--radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); border: 1px solid #e5e7eb;
            overflow: hidden; transition: all 0.3s ease;
            display: flex; flex-direction: column;
            position: relative;
        }
        .offer-card:hover { transform: translateY(-4px); box-shadow: var(--shadow); border-color: var(--primary); }

        /* Badge */
        .badge { position: absolute; top: 10px; right: 10px; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
        .badge-hot { background: #ecfdf5; color: #059669; }
        .badge-wait { background: #f3f4f6; color: #9ca3af; }

        /* Card Header */
        .card-header { padding: 20px 15px 10px; text-align: center; height: 70px; display: flex; align-items: center; justify-content: center; }
        .brand-logo { max-height: 40px; max-width: 140px; object-fit: contain; }

        /* Card Body */
        .card-body { padding: 10px 20px; flex: 1; }
        .brand-name { text-align: center; font-weight: 700; font-size: 16px; margin-bottom: 15px; color: var(--text-dark); }
        
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; }
        .info-label { color: var(--text-gray); }
        .info-val { font-weight: 600; color: var(--text-dark); }
        .highlight { color: #d97706; }

        /* Card Footer */
        .card-footer { padding: 15px 20px 20px; }
        .btn {
            display: flex; justify-content: center; align-items: center; gap: 8px;
            width: 100%; padding: 12px; border-radius: 8px;
            font-weight: 600; font-size: 14px; text-decoration: none;
            transition: 0.2s; border: none; cursor: pointer;
        }
        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 2px 4px rgba(254, 198, 41, 0.3); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-disabled { background: #e5e7eb; color: #9ca3af; cursor: not-allowed; }
        
        .card-disabled { opacity: 0.6; filter: grayscale(100%); }

        /* LOADING & HELPER */
        .loading { text-align: center; padding: 40px; width: 100%; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        #helper-box { background: #111827; color: #10b981; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: none; font-family: monospace; }
        #helper-textarea { width: 100%; height: 150px; background: #000; color: #fff; border: 1px solid #374151; padding: 10px; margin-top: 10px; border-radius: 4px; }
        
        /* FOOTER */
        .site-footer { background: var(--white); padding: 30px 0; margin-top: 50px; border-top: 1px solid #e5e7eb; text-align: center; }
        .footer-text { color: var(--text-gray); font-size: 13px; }

        @media (max-width: 600px) {
            .header-container { padding: 0 15px; }
            .offers-grid { grid-template-columns: 1fr; gap: 15px; }
            .offer-card { flex-direction: row; align-items: center; padding: 10px; height: auto; }
            .card-header { width: 80px; height: 80px; padding: 5px; border-right: 1px solid #f3f4f6; }
            .brand-logo { max-height: 50px; max-width: 100%; }
            .card-body { padding: 0 15px; }
            .brand-name { text-align: left; margin-bottom: 5px; font-size: 15px; }
            .info-row { margin-bottom: 2px; font-size: 12px; }
            .info-row:not(:first-child) { display: none; } /* Mobile: Chỉ hiện dòng hạn mức */
            .card-footer { padding: 0; min-width: 90px; }
            .btn { padding: 8px 10px; font-size: 12px; border-radius: 6px; }
            .badge { display: none; }
        }
    </style>
</head>
<body>

    <header class="site-header">
        <div class="header-container">
            <a href="index.html" class="logo">
                <img src="images/catcredit-logo.png" alt="CatCredit" onerror="this.style.display='none'; this.parentElement.innerText='CATCREDIT'">
            </a>
            <a href="index.html" class="nav-link"><i class="fa-solid fa-house"></i> Trang chủ</a>
        </div>
    </header>

    <div class="main-container">
        
        <div id="helper-box">
            <h3 style="color:#fec629">⚠️ COPY MÃ NÀY VÀO FILE: links.json</h3>
            <textarea id="helper-textarea"></textarea>
        </div>

        <div class="section-title">Gói vay đề xuất tốt nhất</div>

        <div id="offers-grid" class="offers-grid">
            <div class="loading">
                <div class="spinner"></div>
                <p>Đang tìm ưu đãi tốt nhất...</p>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <p class="footer-text">© 2024 CatCredit.vn - Giải pháp tài chính thông minh</p>
        <p style="font-size: 11px; margin-top:5px;"><a href="admin-tool.html" style="color:#ccc; text-decoration:none">Admin Access</a></p>
    </footer>

    <script>
        const PUB_ID = "28janns";
        const TOKEN = "hpoRHLinw3JgcQaV6g6SaQ=="; 
        const API_URL = `https://publisher-api.riofintech.net/offer/all?pub_id=${PUB_ID}&token=${encodeURIComponent(TOKEN)}`;

        // 1. DATA THÔNG MINH
        function getSmartInfo(name) {
            let n = name.toLowerCase();
            if(n.includes('doctor')) return { limit: '10 Triệu', rate: '0% lần đầu', time: '30 ngày' };
            if(n.includes('moneycat')) return { limit: '15 Triệu', rate: '0% phí', time: '7 - 30 ngày' };
            if(n.includes('takomo')) return { limit: '10 Triệu', rate: 'Duyệt nhanh', time: 'Linh hoạt' };
            if(n.includes('vayvnd')) return { limit: '15 Triệu', rate: '0% lãi', time: '30 ngày' }; // Fix VayVND
            if(n.includes('f88') || n.includes('vietmoney')) return { limit: '50 Triệu', rate: 'Cầm đồ', time: '12 tháng' };
            if(n.includes('mafc') || n.includes('mcredit')) return { limit: '70 Triệu', rate: '1.67%/tháng', time: '36 tháng' };
            return { limit: '1 - 10 Triệu', rate: 'Ưu đãi tốt', time: 'Linh hoạt' };
        }

        // 2. LÀM SẠCH TÊN HIỂN THỊ (FIX CỨNG)
        function getCleanName(rawName) {
            let n = rawName.toLowerCase();
            if (n.includes('vayvnd')) return 'VayVND';
            if (n.includes('cayvang')) return 'Cây Vàng';
            if (n.includes('doctor')) return 'DoctorDong';
            if (n.includes('moneycat')) return 'MoneyCat';
            if (n.includes('tamo')) return 'Tamo';
            if (n.includes('senmo')) return 'Senmo';
            if (n.includes('robocash')) return 'Robocash';
            if (n.includes('oncredit')) return 'OnCredit';
            if (n.includes('takomo')) return 'Takomo';
            if (n.includes('kredivo')) return 'Kredivo';
            if (n.includes('jeff')) return 'Jeff App';
            if (n.includes('crezu')) return 'Crezu';
            if (n.includes('atm')) return 'ATM Online';
            if (n.includes('f88')) return 'F88';
            if (n.includes('mafc')) return 'Mirae Asset';
            
            // Nếu không có trong danh sách trên thì dọn rác
            return rawName.replace(/\(.*\)/g, '')
                          .replace(/(VN|CP|CPL|CPS|CPI|Android|iOS|Web|App|APK)/gi, '')
                          .trim();
        }

        // 3. LOGIC LẤY LINK & CHECK KEY
        function getMyLink(name, links) {
            if (!links) return null;
            for (const [key, url] of Object.entries(links)) {
                if (url && url.length > 5 && name.toLowerCase().includes(key.toLowerCase())) return url;
            }
            return null;
        }
        function getBrandKey(name) { return name.toLowerCase().trim().split(/[\s\-\.\(\)]+/)[0]; }

        // MAIN FUNCTION
        async function init() {
            const grid = document.getElementById('offers-grid');
            const helper = document.getElementById('helper-box');
            
            try {
                const [apiRes, linkRes] = await Promise.all([
                    fetch(API_URL),
                    fetch('links.json').catch(() => null)
                ]);

                const apiData = await apiRes.json();
                let myLinks = {};

                if (linkRes && linkRes.ok) {
                    myLinks = await linkRes.json();
                } else {
                    helper.style.display = 'block'; // Hiện bảng copy nếu chưa có file link
                }

                if (apiData.status !== 1 || !apiData.data) throw new Error("No Data");

                // TOOL COPY CHO ADMIN
                if (helper.style.display === 'block') {
                    let txt = "{\n" + apiData.data.map((o,i) => `  "${o.name}": ""` + (i<apiData.data.length-1?",":"")).join("\n") + "\n}";
                    document.getElementById('helper-textarea').value = txt;
                }

                // XỬ LÝ DỮ LIỆU: GỘP TRÙNG & LỌC
                let uniqueMap = {};
                apiData.data.forEach(item => {
                    let brand = getBrandKey(item.name);
                    let link = getMyLink(item.name, myLinks);
                    let clean = getCleanName(item.name);
                    let info = getSmartInfo(item.name);
                    let hasLink = !!link;

                    // Logic gộp: Ưu tiên cái có Link
                    if (!uniqueMap[brand] || (!uniqueMap[brand].hasLink && hasLink)) {
                        uniqueMap[brand] = { ...item, display: clean, link: link, hasLink: hasLink, info: info };
                    }
                });

                let offers = Object.values(uniqueMap).sort((a,b) => b.hasLink - a.hasLink);
                
                // RENDER
                grid.innerHTML = offers.map(o => {
                    let active = o.hasLink;
                    let clsBox = active ? "offer-card" : "offer-card card-disabled";
                    let badge = active ? `<div class="badge badge-hot">Đề xuất</div>` : ``;
                    let btnCls = active ? "btn btn-primary" : "btn btn-disabled";
                    let btnTxt = active ? 'ĐĂNG KÝ NGAY' : 'BẢO TRÌ';
                    let href = active ? o.link : "javascript:void(0)";
                    let target = active ? "_blank" : "_self";

                    return `
                    <div class="${clsBox}">
                        ${badge}
                        <div class="card-header">
                            <img src="${o.avatar}" class="brand-logo" alt="${o.display}" onerror="this.style.display='none'">
                        </div>
                        <div class="card-body">
                            <div class="brand-name">${o.display}</div>
                            <div class="info-row">
                                <span class="info-label">Hạn mức</span>
                                <span class="info-val highlight">${o.info.limit}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Lãi suất</span>
                                <span class="info-val">${o.info.rate}</span>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="${href}" target="${target}" class="${btnCls}">
                                ${btnTxt} ${active ? '<i class="fa-solid fa-arrow-right"></i>' : ''}
                            </a>
                        </div>
                    </div>`;
                }).join('');

            } catch (e) {
                console.error(e);
                grid.innerHTML = `<p style="text-align:center;width:100%;color:red">Lỗi kết nối. Vui lòng thử lại.</p>`;
            }
        }

        init();
    </script>
</body>
</html>
